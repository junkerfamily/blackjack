<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casino Blackjack</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cards.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/blackjack.css') }}">
</head>
<body>
    <div class="casino-table">
        <!-- Header -->
        <header class="table-header">
            <h1>üé∞ CASINO BLACKJACK</h1>
            <!-- Cut Card Display -->
            <div class="cut-card-display" id="cut-card-display">
                <div class="cut-card-info">
                    <span class="cut-card-label">Shoe:</span>
                    <span class="cut-card-count" id="cut-card-count">312 cards</span>
                </div>
                <div class="cut-card-progress-container">
                    <div class="cut-card-progress-bar" id="cut-card-progress-bar">
                        <div class="cut-card-marker" id="cut-card-marker"></div>
                        <div class="cut-card-fill" id="cut-card-fill"></div>
                    </div>
                </div>
                <div class="cut-card-warning" id="cut-card-warning" style="display: none;">
                    ‚ö†Ô∏è Reshuffle approaching
                </div>
            </div>
            <div class="header-controls">
                <button class="info-toggle" id="info-toggle" aria-label="Rules and help">
                    ‚ÑπÔ∏è
                </button>
                <button class="settings-toggle" id="settings-toggle" aria-label="Heckler settings">
                    ‚öôÔ∏è
                </button>
            </div>
        </header>

        <!-- Rules Panel -->
        <div class="rules-panel" id="rules-panel" role="dialog" aria-labelledby="rules-title" aria-hidden="true">
            <div class="rules-header">
                <span class="rules-title" id="rules-title">How to Play</span>
                <button class="rules-close" id="rules-close" aria-label="Close rules">‚úï</button>
            </div>
            <div class="rules-content">
                <!-- Basic Rules Page -->
                <div class="rules-page" id="rules-page-basic">
                    <h3>Basic Rules</h3>
                    <ul>
                        <li><strong>Goal:</strong> Beat the dealer by getting closer to 21 without going over.</li>
                        <li><strong>Card Values:</strong> Cards 2-10 are worth face value. Face cards (J, Q, K) are worth 10. Aces are worth 1 or 11.</li>
                        <li><strong>Blackjack:</strong> An Ace and a 10-value card dealt initially. Pays 3:2.</li>
                        <li><strong>Bust:</strong> Going over 21 means you lose immediately.</li>
                        <li><strong>Deal:</strong> You and dealer each get 2 cards. One dealer card is hidden.</li>
                        <li><strong>Hit:</strong> Take another card.</li>
                        <li><strong>Stand:</strong> Keep your current hand and let dealer play.</li>
                    </ul>
                    <div class="rules-navigation">
                        <button class="rules-next-btn" id="rules-next-btn">Advanced Rules ‚Üí</button>
                        <button class="rules-next-btn" id="rules-shortcuts-btn">Keyboard Shortcuts ‚Üí</button>
                    </div>
                </div>

                <!-- Advanced Rules Page -->
                <div class="rules-page" id="rules-page-advanced" style="display: none;">
                    <h3>Advanced Rules</h3>
                    <ul>
                        <li><strong>Double Down:</strong> Double your bet and receive exactly one more card. Best after 2 cards.</li>
                        <li><strong>Split:</strong> If you have two cards of equal value, split them into two hands. Each hand gets one new card.</li>
                        <li><strong>Split Aces:</strong> When splitting Aces, you get only one card per hand and cannot hit or double down.</li>
                        <li><strong>Surrender:</strong> Forfeit your hand before taking any actions and recover half your bet. Only available on your first action with exactly 2 cards.</li>
                        <li><strong>Insurance:</strong> When dealer shows an Ace, bet up to half your bet that they have Blackjack. Pays 2:1 if correct.</li>
                        <li><strong>Even Money:</strong> When you have Blackjack and dealer shows an Ace, you can take Even Money (1:1 payout) to guarantee a win, or decline and risk a push if dealer also has Blackjack (but win 3:2 if dealer doesn't).</li>
                        <li><strong>Soft Hand:</strong> A hand with an Ace counted as 11 (like Ace-6 = soft 17).</li>
                        <li><strong>Hard Hand:</strong> A hand where the Ace must count as 1, or no Aces (like 10-9 = hard 19).</li>
                        <li><strong>Dealer Rules:</strong> Dealer must hit on 16 or less, must stand on 17 or more.</li>
                        <li><strong>Push:</strong> If your hand ties the dealer's, it's a push and your bet is returned.</li>
                        <li><strong>5 Card Charlie:</strong> If you get 5 cards without busting, you automatically win that hand!</li>
                        <li><strong>Shoe & Cut Card Display:</strong> The shoe graphic shows remaining cards in the 6-deck shoe. When it drops below 156 cards (50%), a reshuffle warning appears. The deck automatically reshuffles before the next deal when it reaches the cut card threshold.</li>
                    </ul>
                    <div class="rules-navigation">
                        <button class="rules-prev-btn" id="rules-prev-btn">‚Üê Basic Rules</button>
                        <button class="rules-next-btn" id="rules-casino-info-btn">Casino Information ‚Üí</button>
                    </div>
                </div>

                <!-- Keyboard Shortcuts Page -->
                <div class="rules-page" id="rules-page-shortcuts" style="display: none;">
                    <h3>Keyboard Shortcuts</h3>
                    <ul>
                        <li><strong>D:</strong> Deal Cards</li>
                        <li><strong>H:</strong> Hit</li>
                        <li><strong>S:</strong> Stand</li>
                        <li><strong>R:</strong> Surrender</li>
                        <li><strong>I:</strong> Insurance / Even Money</li>
                        <li><strong>1:</strong> Place $100 Bet</li>
                        <li><strong>5:</strong> Place $500 Bet</li>
                    </ul>
                    <div class="rules-navigation">
                        <button class="rules-prev-btn" id="rules-shortcuts-back-btn">‚Üê Basic Rules</button>
                    </div>
                </div>

                <!-- Casino Information Page -->
                <div class="rules-page" id="rules-page-casino" style="display: none;">
                    <h3>Casino Information</h3>
                    <div class="casino-info-card">
                        <div class="casino-info-header">
                            <div class="casino-info-icon" aria-hidden="true">üé∞</div>
                            <div class="casino-info-heading">
                                <div class="casino-info-title">Professional Shoe Configuration</div>
                                <div class="casino-info-subtitle">We mirror a Las Vegas six-deck shoe so betting flows like a real table.</div>
                            </div>
                        </div>

                        <div class="shoe-stats-grid">
                            <div class="shoe-stat">
                                <span class="stat-label">Shoe Size</span>
                                <span class="stat-value">6 decks ‚Ä¢ 312 cards</span>
                                <span class="stat-note">All six decks are shuffled together the moment the table opens.</span>
                            </div>
                            <div class="shoe-stat">
                                <span class="stat-label">Cut Card &amp; Reshuffle</span>
                                <span class="stat-value">Shuffle at 156 cards (3 decks)</span>
                                <span class="stat-note">As soon as the live stack dips under half a shoe we rebuild the full six-deck stack.</span>
                            </div>
                            <div class="shoe-stat">
                                <span class="stat-label">Per-Rank Inventory</span>
                                <span class="stat-value">24 copies of every rank</span>
                                <span class="stat-note">Including 96 ten-value cards and 24 aces‚Äîplenty of blackjack potential.</span>
                            </div>
                            <div class="shoe-stat">
                                <span class="stat-label">House Rationale</span>
                                <span class="stat-value">Casino-style protection</span>
                                <span class="stat-note">Multi-deck shoes slow counting, smooth out variance, and keep the pace authentic.</span>
                            </div>
                        </div>

                        <div class="casino-info-footer">
                            We automatically reshuffle before the next deal whenever the live pile drops below the three-deck marker‚Äîno thin shoes, no surprises.
                        </div>
                    </div>
                    <div class="rules-navigation">
                        <button class="rules-prev-btn" id="rules-back-btn">‚Üê Advanced Rules</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Panel -->
        <div class="settings-panel" id="settings-panel" role="dialog" aria-labelledby="settings-title" aria-hidden="true">
            <div class="settings-header">
                <span class="settings-title" id="settings-title">Heckler Settings</span>
                <button class="settings-close" id="settings-close" aria-label="Close settings">‚úï</button>
            </div>
            <div class="settings-content">
                <div class="settings-row">
                    <label for="heckler-enabled-toggle" class="settings-label">Enable Voice</label>
                    <input type="checkbox" id="heckler-enabled-toggle" class="settings-checkbox">
                </div>
                <div class="settings-row">
                    <label for="heckler-voice-select" class="settings-label">Voice</label>
                    <select id="heckler-voice-select" class="settings-select" disabled>
                        <option value="" selected>Loading voices‚Ä¶</option>
                    </select>
                </div>
                <div class="settings-row">
                    <span class="settings-label">Voice Test</span>
                    <button type="button" class="btn-secondary" id="heckler-test-button">Play Test Phrase</button>
                </div>
                <div class="settings-row">
                    <span class="settings-label">Sound Test</span>
                    <button type="button" class="btn-secondary" id="trumpet-test-button">Play Trumpet Sound</button>
                </div>
                <div class="settings-row">
                    <label for="heckler-speed-range" class="settings-label">Speed</label>
                    <div class="settings-range-wrapper">
                        <input type="range" id="heckler-speed-range" min="0.6" max="1.6" step="0.05" value="1.05">
                        <span class="settings-range-value" id="heckler-speed-display">1.05√ó</span>
                    </div>
                </div>
                <div class="settings-row">
                    <label for="bankroll-setting-input" class="settings-label">Starting Bankroll</label>
                    <input type="number" id="bankroll-setting-input" class="settings-input" min="1" max="1000000" step="1" value="1000">
                    <span class="settings-helper" id="bankroll-setting-helper">Used when refreshing bankroll (max $1,000,000)</span>
                </div>
                <div class="settings-row">
                    <label for="dealer-delay-input" class="settings-label">Dealer Card Delay (ms)</label>
                    <input type="number" id="dealer-delay-input" class="settings-input" min="0" max="5000" step="50" value="1000">
                    <span class="settings-helper" id="dealer-delay-helper">Delay between dealer hits (0-5000 ms)</span>
                </div>
                <div class="settings-row">
                    <label for="player-delay-input" class="settings-label">Player Card Delay (ms)</label>
                    <input type="number" id="player-delay-input" class="settings-input" min="0" max="5000" step="50" value="150">
                    <span class="settings-helper" id="player-delay-helper">Delay between player card animations (0-5000 ms). Current: 150 ms</span>
                </div>
                <div class="settings-row">
                    <label for="dealer-hits-soft17-toggle" class="settings-label">Dealer Hits Soft 17</label>
                    <input type="checkbox" id="dealer-hits-soft17-toggle" class="settings-checkbox">
                    <span class="settings-helper">When enabled, dealer hits on Ace-6 (soft 17). Default: dealer stands on all 17s.</span>
                </div>
                <div class="settings-row">
                    <label for="force-dlr-hand-input" class="settings-label">Force DLR Hand (TEST)</label>
                    <input type="text" id="force-dlr-hand-input" class="settings-input" placeholder="e.g., 10,A or A,10" maxlength="10">
                    <span class="settings-helper">Format: "rank1,rank2" (e.g., "10,A" = 10 hole + A upcard). Leave empty to disable.</span>
                </div>
                <div class="settings-row">
                    <label for="force-player-hand-input" class="settings-label">Force Player Hand (TEST)</label>
                    <input type="text" id="force-player-hand-input" class="settings-input" placeholder="e.g., A,A or 10,10" maxlength="10">
                    <span class="settings-helper">Format: "rank1,rank2" (e.g., "A,A" for split, "10,10" for pair). Leave empty to disable.</span>
                </div>
                <div class="settings-row">
                    <span class="settings-label">Dealer Peek</span>
                    <div style="display: flex; flex-direction: column; gap: 6px; flex: 1;">
                        <button type="button" id="test-peek-btn" class="btn-secondary" style="align-self: flex-start;">Test Animation</button>
                        <span class="settings-helper">Instantly plays the peek animation so you can confirm the visuals.</span>
                    </div>
                </div>
                <div class="settings-row">
                    <span class="settings-label">Hand Log</span>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button type="button" id="view-log-hand-btn" class="btn-secondary" style="padding: 8px 16px;">View Log</button>
                        <a href="#" id="download-log-hand-link" class="btn-secondary" style="text-decoration: none; display: inline-block; padding: 8px 16px;">Download LogHand.log</a>
                        <button type="button" id="clear-log-hand-btn" class="btn-secondary" style="padding: 8px 16px;">Clear Log</button>
                    </div>
                </div>
                <div class="settings-note" id="heckler-settings-note" hidden>
                    Speech synthesis is not supported in this browser.
                </div>
            </div>
        </div>

        <div class="table-body">
            <div class="primary-column">
                <!-- Dealer Area -->
                <section class="dealer-area">
                    <button type="button" class="shuffle-trigger-btn" id="shuffle-trigger-btn" title="Show shuffle overlay">
                        Shuffle
                    </button>
                    <div id="dealer-hand" class="card-hand"></div>
                    
                    <!-- Dealer Info Bar -->
                    <div class="dealer-display">
                        <div class="dealer-info-in-bar">
                            <span class="area-label-inline">DEALER</span>
                            <span class="hand-value-inline" id="dealer-value">Value: ?</span>
                        </div>
                        <div class="game-message" id="game-message"></div>
                    </div>

                    <!-- Shuffle Overlay -->
                    <div class="shuffle-overlay" id="shuffle-overlay" aria-live="polite">
                        <div class="shuffle-stack" role="img" aria-label="Shuffling cards animation">
                            <div class="shuffle-card card-one"></div>
                            <div class="shuffle-card card-two"></div>
                            <div class="shuffle-card card-three"></div>
                            <div class="shuffle-card card-four"></div>
                        </div>
                        <div class="shuffle-status" id="shuffle-status">Shuffling‚Ä¶</div>
                    </div>
                </section>

                <!-- Player Area -->
                <section class="player-area">
                    <div id="player-hand" class="card-hand"></div>
                    
                    <!-- Current Bet Display with Player Info -->
                    <div class="bet-display">
                        <div class="player-info-in-bar">
                            <span class="area-label-inline">PLAYER</span>
                            <span class="hand-value-inline" id="player-value">Value: 0</span>
                        </div>
                        <div class="bet-info">
                            <span class="bet-label">Current Bet:</span>
                            <span class="bet-amount" id="current-bet">$0</span>
                            <button class="btn-clear-bet" id="clear-bet-btn" onclick="clearBet()">Clear Bet</button>
                        </div>
                    </div>
                </section>

                <!-- Insurance / Even Money Offer -->
                <div class="insurance-offer" id="insurance-offer">
                    <button class="btn-insurance disabled" id="insurance-btn" aria-disabled="true" title="Available when dealer shows Ace">Insurance ‚Äì pays 2:1</button>
                    <button class="btn-insurance-decline" id="insurance-decline" style="display: none;">No thanks</button>
                </div>

                <!-- Game Management -->
                <section class="game-management">
                    <button class="btn-secondary" id="refresh-bankroll-btn" onclick="refreshBankroll()">Refresh Bankroll</button>
                    <button class="btn-secondary" id="auto-mode-btn">Auto Mode</button>
                    <button class="btn-secondary" id="log-hand-btn" style="display: none;">Log Hand</button>
                </section>

                <!-- Action Status Message -->
                <div class="action-status" id="action-status"></div>

                <!-- Auto Mode Panel -->
                <div class="auto-mode-panel" id="auto-mode-panel" style="display: none;">
                    <div class="auto-mode-card">
                        <div class="auto-mode-header">Auto Mode</div>
                        <div class="auto-mode-body">
                            <label class="auto-mode-label" for="auto-bet-input">Default Bet</label>
                            <input type="number" id="auto-bet-input" min="1" step="1" value="100">
                            <label class="auto-mode-label" for="auto-hands-input">Hands to Play</label>
                            <input type="number" id="auto-hands-input" min="1" step="1" value="5">
                            <label class="auto-mode-label" for="auto-strategy-select">Strategy</label>
                            <select id="auto-strategy-select" class="auto-mode-select">
                                <option value="basic">Basic Strategy</option>
                                <option value="conservative">Conservative</option>
                                <option value="aggressive">Aggressive</option>
                            </select>
                            <label class="auto-mode-label" for="auto-betting-strategy-select">Betting Strategy</label>
                            <select id="auto-betting-strategy-select" class="auto-mode-select">
                                <option value="fixed">Fixed Bet</option>
                                <option value="progressive">Progressive (Martingale)</option>
                                <option value="percentage">Percentage of Bankroll</option>
                            </select>
                            <div id="auto-percentage-container" style="display: none;">
                                <label class="auto-mode-label" for="auto-percentage-input">Bet Percentage (%)</label>
                                <input type="number" id="auto-percentage-input" min="1" max="100" step="1" value="5">
                            </div>
                            <div class="auto-mode-label">Insurance Preference</div>
                            <div class="auto-mode-radio-group">
                                <label><input type="radio" name="auto-insurance" value="always"> Always take</label>
                                <label><input type="radio" name="auto-insurance" value="never" checked> Never take</label>
                            </div>
                            <label class="auto-mode-label" for="auto-double-down-select">Double Down</label>
                            <select id="auto-double-down-select" class="auto-mode-select">
                                <option value="always">Always</option>
                                <option value="never">Never</option>
                                <option value="recommended" selected>When Recommended</option>
                            </select>
                            <label class="auto-mode-label" for="auto-split-select">Split</label>
                            <select id="auto-split-select" class="auto-mode-select">
                                <option value="always">Always</option>
                                <option value="never">Never</option>
                                <option value="recommended" selected>When Recommended</option>
                            </select>
                            <label class="auto-mode-label" for="auto-surrender-select">Surrender</label>
                            <select id="auto-surrender-select" class="auto-mode-select">
                                <option value="always">Always</option>
                                <option value="never">Never</option>
                                <option value="recommended" selected>When Recommended</option>
                            </select>
                            <div class="auto-mode-actions">
                                <button class="btn-primary" id="auto-start-btn">Start</button>
                                <button class="btn-secondary" id="auto-cancel-btn">Cancel</button>
                            </div>
                            <div class="auto-mode-error" id="auto-error" aria-live="polite"></div>
                        </div>
                    </div>
                </div>

            <div class="auto-status" id="auto-status" style="display: none;">
                <span id="auto-status-text"></span>
                <div class="auto-status-actions">
                    <!-- <button id="auto-download-log-btn" class="btn-download-log" style="display: none;">Download Log</button> -->
                    <button id="auto-view-log-btn" class="btn-download-log" style="display: none;">View Log</button>
                    <button id="auto-status-close-btn" class="auto-status-close" aria-label="Close auto mode status" title="Close">√ó</button>
                </div>
            </div>
            </div>

            <div class="secondary-column">
                <!-- Betting Area -->
                <section class="betting-area" id="betting-area">
                    <div class="betting-label" id="betting-label">Place Your Bet</div>
                    <div class="table-limits-display" id="table-limits-display">
                        <span class="limits-label">Table Limits:</span>
                        <span class="limits-value" id="table-limits-value">$5 - $500</span>
                    </div>
                    <div class="chip-tray" id="chip-tray">
                        <button class="chip" data-value="1" onclick="selectChip(1)">
                            <span class="chip-value">$1</span>
                        </button>
                        <button class="chip" data-value="5" onclick="selectChip(5)">
                            <span class="chip-value">$5</span>
                        </button>
                        <button class="chip" data-value="10" onclick="selectChip(10)">
                            <span class="chip-value">$10</span>
                        </button>
                        <button class="chip" data-value="25" onclick="selectChip(25)">
                            <span class="chip-value">$25</span>
                        </button>
                        <button class="chip" data-value="100" onclick="selectChip(100)">
                            <span class="chip-value">$100</span>
                        </button>
                        <button class="chip" data-value="500" onclick="selectChip(500)">
                            <span class="chip-value">$500</span>
                        </button>
                    </div>
                    <div class="betting-controls">
                        <button class="btn-primary" id="deal-btn" onclick="dealCards()">Deal Cards</button>
                    </div>
                    <section class="game-controls" id="game-controls" style="display: none;">
                        <button class="btn-action" id="hit-btn" onclick="playerHit()">Hit</button>
                        <button class="btn-action" id="stand-btn" onclick="playerStand()">Stand</button>
                        <button class="btn-action" id="double-btn" onclick="playerDoubleDown()">Double Down</button>
                        <button class="btn-action" id="split-btn" onclick="playerSplit()" style="display: none;">Split</button>
                        <button class="btn-action" id="surrender-btn" onclick="playerSurrender()" style="display: none;">Surrender</button>
                    </section>
                    <div class="balance-display-block">
                        <span class="balance-label">Balance:</span>
                        <span class="balance-amount" id="balance">$1,000</span>
                    </div>
                </section>

                <!-- Game History Panel -->
                <section class="game-history-panel">
                    <div class="history-header">üìä Game History (Last 5)</div>
                    <div class="history-list" id="history-list">
                        <div class="history-item-empty">No games yet</div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Table Sign Display -->
        <div class="table-sign-container">
            <div class="table-sign" id="table-sign">
                <div class="table-sign-content" id="table-sign-content">
                    <span class="sign-text">BLACKJACK PAYS 3:2</span>
                    <span class="sign-separator">‚Ä¢</span>
                    <span class="sign-text">DEALER STANDS ON 17</span>
                    <span class="sign-separator">‚Ä¢</span>
                    <span class="sign-text">TABLE LIMITS $5 - $500</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto Mode Log Viewer -->
    <div class="auto-log-viewer-overlay" id="auto-log-viewer-overlay" style="display: none;">
        <div class="auto-log-viewer-panel">
            <div class="auto-log-viewer-header">
                <div class="auto-log-viewer-title">Auto Mode Log</div>
                <div class="auto-log-viewer-buttons">
                    <button id="auto-log-viewer-copy-btn" class="btn-log-viewer-action" type="button" title="Copy log to clipboard">üìã Copy</button>
                    <button id="auto-log-viewer-close-btn" class="btn-primary btn-log-viewer-close" type="button">Close</button>
                </div>
            </div>
            <textarea id="auto-log-viewer-content" class="auto-log-viewer-content" readonly></textarea>
        </div>
    </div>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Processing...</div>
    </div>

    <!-- Blackjack Celebration Overlay -->
    <div class="blackjack-celebration-overlay" id="blackjack-celebration" style="display: none;">
        <div class="blackjack-celebration-card">
            <div class="blackjack-card-inner">
                <div class="blackjack-card-suit">‚ô†</div>
                <div class="blackjack-card-text">BLACKJACK!</div>
                <div class="blackjack-card-suit">‚ô•</div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/card.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
